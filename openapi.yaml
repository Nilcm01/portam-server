openapi: 3.1.0
info:
  title: PORTA'M Server API
  summary: Public transport validation system backoffice for all of its modules.
  description: >
    This document captures the current Express routes mounted under `/api` and the helper
    endpoints defined in `server.js`. Each controller in `controllers/` documents the underlying
    Supabase tables that back the module. All responses wrap the returned data in a `success` flag and either
    a resource payload or a textual `error` field, except for auth and validation workflows which return
    localized status messages for direct user feedback.
  version: 1.1.0
servers:
  - url: https://portam-server.vercel.app/
    description: Production server
tags:
  - name: Root
    description: Public landing page and health checks.
  - name: Auth
    description: User registration, login, and session validation.
  - name: Users
    description: Manage end users and their profile data.
  - name: UserGroups
    description: Manage user memberships and expiration rules per group.
  - name: Suports
    description: Attach or detach NFC suports (physical cards) to users.
  - name: Receipts
    description: Track receipts linked to user purchases.
  - name: Groups
    description: Define fare groups and duration rules.
  - name: Stations
    description: CRUD for stations and their associated zones.
  - name: Titles
    description: Fare product catalog definitions.
  - name: UserTitles
    description: Issue, manage, and activate purchased titles per user.
  - name: Validation
    description: Run the full validation pipeline from a suport at a station.
  - name: Requests
    description: User group access requests and evaluations.
  - name: Zones
    description: Define transport fare zones.
paths:
  /:
    get:
      tags: [Root]
      operationId: getWelcome
      summary: Welcome banner
      description: >
        Returns a friendly message and current timestamp as defined in `server.js`.
      responses:
        '200':
          description: API welcome payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootResponse'
        '500':
          $ref: '#/components/responses/ServerError'
  /health:
    get:
      tags: [Root]
      operationId: getHealth
      summary: Health check
      description: Lightweight probe that confirms the server is alive.
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/auth/register:
    post:
      tags: [Auth]
      operationId: registerUser
      summary: Register user
      description: >
        Creates a new user, assigns age-based groups (16/30/65) when applicable,
        and opens a device session that returns an access token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRegisterRequest'
      responses:
        '201':
          $ref: '#/components/responses/AuthRegisterSuccess'
        '400':
          $ref: '#/components/responses/AuthRegisterBadRequest'
        '409':
          $ref: '#/components/responses/AuthRegisterConflict'
        '500':
          $ref: '#/components/responses/AuthServerError'
  /api/auth/login:
    post:
      tags: [Auth]
      operationId: loginUser
      summary: Login user
      description: >
        Validates credentials and issues a new session token for the supplied device.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
      responses:
        '200':
          $ref: '#/components/responses/AuthLoginSuccess'
        '400':
          $ref: '#/components/responses/AuthLoginBadRequest'
        '401':
          $ref: '#/components/responses/AuthLoginUnauthorized'
        '500':
          $ref: '#/components/responses/AuthServerError'
  /api/auth/check-session:
    post:
      tags: [Auth]
      operationId: checkSession
      summary: Check session validity
      description: >
        Confirms whether a [user, device] session token is valid and extends the expiration on success.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthCheckSessionRequest'
      responses:
        '200':
          $ref: '#/components/responses/AuthSessionValid'
        '400':
          $ref: '#/components/responses/AuthSessionBadRequest'
        '401':
          $ref: '#/components/responses/AuthSessionUnauthorized'
        '404':
          $ref: '#/components/responses/AuthSessionNotFound'
        '500':
          $ref: '#/components/responses/AuthServerError'
  /api/users:
    get:
      tags: [Users]
      operationId: listUsers
      summary: List users
      description: Returns every user without the hashed password, mirroring `controllers/users.getAllUsers`.
      responses:
        '200':
          description: Users available in the system
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}:
    parameters:
      - $ref: '#/components/parameters/UserId'
    get:
      tags: [Users]
      operationId: getUser
      summary: Get user by ID
      responses:
        '200':
          description: User detail (password removed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    put:
      tags: [Users]
      operationId: updateUser
      summary: Update user profile
      description: Updates user fields and hashes the provided password.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserWriteResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Users]
      operationId: deleteUser
      summary: Delete user
      description: >
        Removes the user and cleans all memberships in `user_groups`.
      responses:
        '200':
          description: User removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDeleteResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/create:
    post:
      tags: [Users]
      operationId: createUser
      summary: Create user
      description: >
        Generates a random 12-digit `id`, inserts the user, and optionally assigns them to groups
        (creating `user_groups` records and respecting group expiration rules). A password is hashed
        before insertion.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserWriteResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/groups:
    parameters:
      - $ref: '#/components/parameters/UserId'
    post:
      tags: [UserGroups]
      operationId: addGroupToUser
      summary: Add group to user
      description: >
        Assigns a group to a user, calculating expiration dates based on birthdate-aware special groups
        (16, 30, 65) or the group's `expiration` days unless a manual expiration is provided.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserGroupAssignmentRequest'
      responses:
        '201':
          description: Membership created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGroupAssignmentResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    get:
      tags: [UserGroups]
      operationId: listUserGroups
      summary: List user groups
      responses:
        '200':
          description: Groups attached to the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGroupsResponse'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/groups/available:
    parameters:
      - $ref: '#/components/parameters/UserId'
    get:
      tags: [UserGroups]
      operationId: listAvailableGroups
      summary: List available groups for user
      description: >
        Returns groups the user is not assigned to, filtered by age-based rules (16/30/65)
        and excluding internal/debug groups (id >= 999).
      responses:
        '200':
          description: Available groups for assignment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAvailableGroupsResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/groups/{groupId}:
    parameters:
      - $ref: '#/components/parameters/UserId'
      - $ref: '#/components/parameters/GroupId'
    delete:
      tags: [UserGroups]
      operationId: removeGroupFromUser
      summary: Remove group from user
      responses:
        '200':
          description: Membership removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserGroupRemovalResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/suports:
    parameters:
      - $ref: '#/components/parameters/UserId'
    get:
      tags: [Suports]
      operationId: listUserSuports
      summary: List user suports
      responses:
        '200':
          description: Suports attached to the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuportListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Suports]
      operationId: addSuportToUser
      summary: Attach suport to user
      description: >
        Creates a suport if the UID does not exist or re-assigns an unbound suport to the user,
        stamping the activation time.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuportCreateRequest'
      responses:
        '201':
          description: Suport created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuportResponse'
        '200':
          description: Suport reassigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuportResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/suports/{uid}:
    parameters:
      - $ref: '#/components/parameters/UserId'
      - name: uid
        in: path
        required: true
        description: Unique suport identifier (varchar UID).
        schema:
          type: string
    get:
      tags: [Suports]
      operationId: getUserSuport
      summary: Get suport details
      responses:
        '200':
          description: Suport record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuportResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Suports]
      operationId: removeSuportFromUser
      summary: Remove suport from user
      responses:
        '200':
          description: Suport detached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuportRemovalResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/users/{id}/receipts:
    parameters:
      - $ref: '#/components/parameters/UserId'
    get:
      tags: [Receipts]
      operationId: listReceiptsForUser
      summary: List receipts for user
      description: Returns receipts ordered by most recent timestamp.
      responses:
        '200':
          description: Receipts for the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceiptListResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Receipts]
      operationId: addReceiptToUser
      summary: Add receipt to user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReceiptCreateRequest'
      responses:
        '201':
          description: Receipt created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceiptResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/groups:
    get:
      tags: [Groups]
      operationId: listGroups
      summary: List groups
      responses:
        '200':
          description: Groups catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Groups]
      operationId: createGroup
      summary: Create group
      description: >
        Inserts a new group. If no id is supplied, a random numeric id is generated after checking uniqueness.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GroupWriteRequest'
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/groups/{id}:
    parameters:
      - $ref: '#/components/parameters/GroupId'
    get:
      tags: [Groups]
      operationId: getGroup
      summary: Get group by ID
      responses:
        '200':
          description: Group detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    put:
      tags: [Groups]
      operationId: updateGroup
      summary: Update group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GroupUpdateRequest'
      responses:
        '200':
          description: Group updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Groups]
      operationId: deleteGroup
      summary: Delete group
      responses:
        '200':
          description: Group deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/requests:
    get:
      tags: [Requests]
      operationId: listRequests
      summary: List requests
      responses:
        '200':
          description: Group access requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Requests]
      operationId: createRequest
      summary: Create request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestCreateRequest'
      responses:
        '201':
          description: Request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/requests/{id}:
    parameters:
      - $ref: '#/components/parameters/RequestId'
    get:
      tags: [Requests]
      operationId: getRequest
      summary: Get request by ID
      responses:
        '200':
          description: Request detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/requests/{id}/approve:
    parameters:
      - $ref: '#/components/parameters/RequestId'
    put:
      tags: [Requests]
      operationId: approveRequest
      summary: Approve request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestDecisionRequest'
      responses:
        '200':
          description: Request approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/requests/{id}/reject:
    parameters:
      - $ref: '#/components/parameters/RequestId'
    put:
      tags: [Requests]
      operationId: rejectRequest
      summary: Reject request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestDecisionRequest'
      responses:
        '200':
          description: Request rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/stations:
    get:
      tags: [Stations]
      operationId: listStations
      summary: List stations
      description: >
        Returns every station merged with its `station_zones` entries.
      responses:
        '200':
          description: Station collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Stations]
      operationId: createStation
      summary: Create station
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationWriteRequest'
      responses:
        '201':
          description: Station created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/stations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Numeric station identifier.
        schema:
          type: integer
    get:
      tags: [Stations]
      operationId: getStation
      summary: Get station
      responses:
        '200':
          description: Station detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    put:
      tags: [Stations]
      operationId: updateStation
      summary: Update station
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationUpdateRequest'
      responses:
        '200':
          description: Station updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Stations]
      operationId: deleteStation
      summary: Delete station
      responses:
        '200':
          description: Station deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationDeleteResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/zones:
    get:
      tags: [Zones]
      operationId: listZones
      summary: List zones
      responses:
        '200':
          description: Zones collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZoneListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Zones]
      operationId: createZone
      summary: Create zone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ZoneWriteRequest'
      responses:
        '201':
          description: Zone created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZoneResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/zones/{id}:
    parameters:
      - $ref: '#/components/parameters/ZoneId'
    get:
      tags: [Zones]
      operationId: getZone
      summary: Get zone
      responses:
        '200':
          description: Zone detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZoneResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    put:
      tags: [Zones]
      operationId: updateZone
      summary: Update zone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ZoneUpdateRequest'
      responses:
        '200':
          description: Zone updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZoneResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Zones]
      operationId: deleteZone
      summary: Delete zone
      responses:
        '200':
          description: Zone deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZoneResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles:
    get:
      tags: [Titles]
      operationId: listTitles
      summary: List titles
      description: >
        Fetches every fare title and enriches it with `groups` and `excluded_groups`.
      responses:
        '200':
          description: Title catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [Titles]
      operationId: createTitle
      summary: Create title
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TitleCreateRequest'
      responses:
        '201':
          description: Title created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Title identifier.
        schema:
          type: integer
    get:
      tags: [Titles]
      operationId: getTitle
      summary: Get title
      responses:
        '200':
          description: Title detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    put:
      tags: [Titles]
      operationId: updateTitle
      summary: Update title
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TitleUpdateRequest'
      responses:
        '200':
          description: Title updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [Titles]
      operationId: deleteTitle
      summary: Delete title
      responses:
        '200':
          description: Title deleted (groups cleaned)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/user/{userId}:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
    get:
      tags: [UserTitles]
      operationId: listUserTitles
      summary: List user titles
      description: >
        Returns issued titles and enriches each entry with the catalog title name and description.
      responses:
        '200':
          description: Titles owned by the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTitleListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    post:
      tags: [UserTitles]
      operationId: assignTitleToUser
      summary: Assign title to user
      description: >
        Copies the title metadata (uses, expiration, re-entry, link, zones) into a new `user_titles`
        record and sets it inactive until explicitly activated.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignTitleRequest'
      responses:
        '201':
          description: User title created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignTitleResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/user/{userId}/active:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
    get:
      tags: [UserTitles]
      operationId: getActiveUserTitle
      summary: Get active user title
      responses:
        '200':
          description: Active title for the user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTitleResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/user/{userId}/available:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
    get:
      tags: [UserTitles]
      operationId: listAvailableTitlesForUser
      summary: List titles available for user
      description: >
        Returns catalog titles available at the current time and compatible with the user's groups.
      responses:
        '200':
          description: Titles available for purchase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TitleListResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/user/{userId}/{userTitleId}:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
      - name: userTitleId
        in: path
        required: true
        description: Identifier of the issued title.
        schema:
          type: string
    get:
      tags: [UserTitles]
      operationId: getUserTitle
      summary: Get issued title
      responses:
        '200':
          description: Issued title detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTitleResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    delete:
      tags: [UserTitles]
      operationId: removeUserTitle
      summary: Remove issued title
      responses:
        '200':
          description: User title deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTitleRemovalResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/titles/user/{userId}/{userTitleId}/activate:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
      - name: userTitleId
        in: path
        required: true
        schema:
          type: string
        description: Identifier of the user title to activate.
    post:
      tags: [UserTitles]
      operationId: activateUserTitle
      summary: Activate issued title
      description: >
        Deactivates any other active titles for the user before setting the requested one to `active: true`.
      responses:
        '200':
          description: Title activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTitleResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
  /api/validation:
    post:
      tags: [Validation]
      operationId: validateSuport
      summary: Validate suport at station
      description: >
        Runs the ten-step validation workflow described in `controllers/validation.js`, including
        automatic initialization of the user title, zone compatibility checks, re-entry and link
        rules, and usage decrementing.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
      responses:
        '200':
          $ref: '#/components/responses/ValidationSuccess'
        '400':
          $ref: '#/components/responses/ValidationMissingParameters'
        '403':
          $ref: '#/components/responses/ValidationForbidden'
        '404':
          $ref: '#/components/responses/ValidationNotFound'
        '410':
          $ref: '#/components/responses/ValidationGone'
        '429':
          $ref: '#/components/responses/ValidationReentryNotPassed'
        '500':
          $ref: '#/components/responses/ValidationInternalServer'
  /api/validation/history/{userId}:
    parameters:
      - $ref: '#/components/parameters/UserIdParam'
    get:
      tags: [Validation]
      operationId: getValidationHistory
      summary: Get validation history for user
      description: Returns the user's validations enriched with station and title names.
      responses:
        '200':
          $ref: '#/components/responses/ValidationHistorySuccess'
        '500':
          $ref: '#/components/responses/ValidationHistoryInternalServer'
components:
  parameters:
    UserId:
      name: id
      in: path
      required: true
      description: 12-digit user identifier.
      schema:
        type: string
        example: '123456789012'
    UserIdParam:
      name: userId
      in: path
      required: true
      description: 12-digit user identifier.
      schema:
        type: string
        example: '123456789012'
    GroupId:
      name: groupId
      in: path
      required: true
      description: Group identifier.
      schema:
        type: string
        example: '16'
    RequestId:
      name: id
      in: path
      required: true
      description: Request identifier (UUID).
      schema:
        type: string
        example: 2cfb0b5b-2c6a-4d8f-9e4b-1cfa3d2c4a9f
    ZoneId:
      name: id
      in: path
      required: true
      description: Zone identifier.
      schema:
        type: integer
        example: 1
  responses:
    BadRequestError:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    AuthMessage:
      description: Authentication workflow response payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthMessage'
    AuthRegisterSuccess:
      description: Registration succeeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthRegisterSuccess'
    AuthRegisterBadRequest:
      description: Missing or invalid registration parameters
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/AuthRegisterMissingParameters'
              - $ref: '#/components/schemas/AuthRegisterInvalidParameters'
    AuthRegisterConflict:
      description: User already exists
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/AuthRegisterUserExistsEmail'
              - $ref: '#/components/schemas/AuthRegisterUserExistsGovId'
    AuthLoginSuccess:
      description: Login succeeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthLoginSuccess'
    AuthLoginBadRequest:
      description: Missing login parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthLoginMissingParameters'
    AuthLoginUnauthorized:
      description: Invalid login credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthLoginInvalidCredentials'
    AuthSessionValid:
      description: Session is valid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthSessionValid'
    AuthSessionBadRequest:
      description: Missing session parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthSessionMissingParameters'
    AuthSessionUnauthorized:
      description: Session token invalid or expired
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/AuthSessionInvalidToken'
              - $ref: '#/components/schemas/AuthSessionExpired'
    AuthSessionNotFound:
      description: Session not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthSessionNotFound'
    AuthServerError:
      description: Internal auth server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthInternalServer'
    ValidationMessage:
      description: Validation workflow response payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationMessage'
    ValidationSuccess:
      description: Validation succeeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationSuccess'
    ValidationMissingParameters:
      description: Missing parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationMissingParameters'
    ValidationForbidden:
      description: Validation forbidden
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/ValidationSuportInactive'
              - $ref: '#/components/schemas/ValidationCannotInitialize'
              - $ref: '#/components/schemas/ValidationInvalidZone'
    ValidationNotFound:
      description: Validation resource not found
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/ValidationSuportNotFound'
              - $ref: '#/components/schemas/ValidationStationNotAvailable'
              - $ref: '#/components/schemas/ValidationNoActiveTitle'
    ValidationGone:
      description: Validation failed due to expiration or exhausted uses
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/ValidationTitleExpired'
              - $ref: '#/components/schemas/ValidationNoUsesLeft'
    ValidationSuportNotFound:
      description: Suport not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationSuportNotFound'
    ValidationSuportInactive:
      description: Suport inactive
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationSuportInactive'
    ValidationStationNotAvailable:
      description: Station not available
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationStationNotAvailable'
    ValidationNoActiveTitle:
      description: No active title for user
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationNoActiveTitle'
    ValidationTitleExpired:
      description: User title expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationTitleExpired'
    ValidationCannotInitialize:
      description: User title cannot be initialized at this station
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationCannotInitialize'
    ValidationReentryNotPassed:
      description: Re-entry time not passed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationReentryNotPassed'
    ValidationInvalidZone:
      description: User title invalid for zone
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationInvalidZone'
    ValidationNoUsesLeft:
      description: No uses left
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationNoUsesLeft'
    ValidationInternalServer:
      description: Internal server error during validation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationInternalServer'
    ValidationHistoryMessage:
      description: Validation history response payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationHistoryMessage'
    ValidationHistorySuccess:
      description: Validation history fetched successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationHistorySuccess'
    ValidationHistoryInternalServer:
      description: Internal server error during history fetch
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationHistoryInternalServer'
  schemas:
    RootResponse:
      type: object
      properties:
        message:
          type: string
          example: Welcome to PORTA'M Server API
        version:
          type: string
          description: API version string declared in `server.js`.
          example: 1.1.0
        timestamp:
          type: string
          description: ISO-like timestamp without timezone (server boot time).
          example: 2026-02-02T10:15:30
      required: [message, version, timestamp]
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: OK
        timestamp:
          type: string
          format: date-time
      required: [status, timestamp]
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: Something went wrong
      required: [success, error]
    AuthRegisterRequest:
      type: object
      properties:
        name:
          type: string
        surname:
          type: string
        govId:
          type: string
          description: Government-issued identifier.
        email:
          type: string
          format: email
        phone:
          type: string
        birthdate:
          type: string
          format: date
        password:
          type: string
          format: password
        deviceId:
          type: string
          description: Client device identifier used to scope the session.
      required: [name, surname, govId, email, phone, birthdate, password, deviceId]
    AuthLoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        deviceId:
          type: string
      required: [email, password, deviceId]
    AuthCheckSessionRequest:
      type: object
      properties:
        userId:
          type: string
        deviceId:
          type: string
        token:
          type: string
      required: [userId, deviceId, token]
    AuthUser:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        surname:
          type: string
        govId:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        birthdate:
          type: string
          format: date
      required: [id, name, surname, govId, email, phone, birthdate]
    AuthMessage:
      type: object
      properties:
        success:
          type: boolean
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        internal:
          type: string
          description: Optional internal error detail for server errors.
        userId:
          type: string
        token:
          type: string
        expiration:
          type: string
          description: ISO-like timestamp without timezone (session expiry).
          example: 2026-02-09T10:15:30
        user:
          $ref: '#/components/schemas/AuthUser'
      required: [success, code, status, msg]
    AuthSuccessMessage:
      type: object
      properties:
        success:
          const: true
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        userId:
          type: string
        token:
          type: string
        expiration:
          type: string
          description: ISO-like timestamp without timezone (session expiry).
          example: 2026-02-09T10:15:30
        user:
          $ref: '#/components/schemas/AuthUser'
      required: [success, code, status, msg, userId, token, expiration, user]
      additionalProperties: false
    AuthErrorMessage:
      type: object
      properties:
        success:
          const: false
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        internal:
          type: string
          description: Optional internal error detail for server errors.
      required: [success, code, status, msg]
      additionalProperties: false
    AuthRegisterSuccess:
      allOf:
        - $ref: '#/components/schemas/AuthSuccessMessage'
        - type: object
          properties:
            code:
              const: 201
            status:
              const: REGISTER_SUCCESS
    AuthRegisterMissingParameters:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 400
            status:
              const: REGISTER_MISSING_PARAMETERS
    AuthRegisterInvalidParameters:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 400
            status:
              const: REGISTER_INVALID_PARAMETERS
    AuthRegisterUserExistsEmail:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 409
            status:
              const: REGISTER_USER_EXISTS_EMAIL
    AuthRegisterUserExistsGovId:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 409
            status:
              const: REGISTER_USER_EXISTS_GOVID
    AuthLoginSuccess:
      allOf:
        - $ref: '#/components/schemas/AuthSuccessMessage'
        - type: object
          properties:
            code:
              const: 200
            status:
              const: LOGIN_SUCCESS
    AuthLoginMissingParameters:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 400
            status:
              const: LOGIN_MISSING_PARAMETERS
    AuthLoginInvalidCredentials:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 401
            status:
              const: LOGIN_INVALID_CREDENTIALS
    AuthSessionValid:
      allOf:
        - $ref: '#/components/schemas/AuthSuccessMessage'
        - type: object
          properties:
            code:
              const: 200
            status:
              const: SESSION_VALID
    AuthSessionMissingParameters:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 400
            status:
              const: SESSION_MISSING_PARAMETERS
    AuthSessionNotFound:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 404
            status:
              const: SESSION_NOT_FOUND
    AuthSessionInvalidToken:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 401
            status:
              const: SESSION_INVALID_TOKEN
    AuthSessionExpired:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 401
            status:
              const: SESSION_EXPIRED
    AuthInternalServer:
      allOf:
        - $ref: '#/components/schemas/AuthErrorMessage'
        - type: object
          properties:
            code:
              const: 500
            status:
              const: ERROR_INTERNAL_SERVER
    Request:
      type: object
      properties:
        id:
          type: string
          description: UUID request identifier.
        created_at:
          type: string
          description: Timestamp formatted as YYYY-MM-DD HH:mm:ss.
          example: 2026-02-02 10:15:30
        user:
          type: string
        group:
          type: integer
        evaluated:
          type: boolean
        evaluated_at:
          type: string
          description: Timestamp formatted as YYYY-MM-DD HH:mm:ss.
          example: 2026-02-02 11:30:00
        evaluated_by:
          type: string
        approved:
          type: boolean
      required: [id, created_at, user, group]
    RequestCreateRequest:
      type: object
      properties:
        user:
          type: string
        group:
          type: integer
      required: [user, group]
    RequestDecisionRequest:
      type: object
      properties:
        evaluated_by:
          type: string
          description: Admin user identifier that evaluates the request.
      required: [evaluated_by]
    RequestListResponse:
      type: object
      properties:
        success:
          type: boolean
        requests:
          type: array
          items:
            $ref: '#/components/schemas/Request'
      required: [success, requests]
    RequestResponse:
      type: object
      properties:
        success:
          type: boolean
        request:
          $ref: '#/components/schemas/Request'
      required: [success, request]
    Receipt:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        user:
          type: string
        amount:
          type: number
          format: float
      required: [id, timestamp, user, amount]
    ReceiptCreateRequest:
      type: object
      properties:
        amount:
          type: number
          format: float
      required: [amount]
    ReceiptListResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        receipts:
          type: array
          items:
            $ref: '#/components/schemas/Receipt'
      required: [success, user_id, receipts]
    ReceiptResponse:
      type: object
      properties:
        success:
          type: boolean
        receipt:
          $ref: '#/components/schemas/Receipt'
      required: [success, receipt]
    User:
      type: object
      properties:
        id:
          type: string
          description: Random 12-digit identifier.
          example: '123456789012'
        name:
          type: string
        surname:
          type: string
        gov_id:
          type: string
          description: Government-issued identifier.
        email:
          type: string
          format: email
        phone:
          type: string
        birthdate:
          type: string
          format: date
      required: [id, name, surname, gov_id, email, phone, birthdate]
    UserListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
      required: [success, users]
    UserResponse:
      type: object
      properties:
        success:
          type: boolean
        user:
          $ref: '#/components/schemas/User'
      required: [success, user]
    UserCreateRequest:
      type: object
      properties:
        name:
          type: string
        surname:
          type: string
        gov_id:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        birthdate:
          type: string
          format: date
        password:
          type: string
          format: password
          description: Required by current implementation (hashed before insert).
        groups:
          type: array
          description: Optional list of group IDs to insert into `user_groups`.
          items:
            type: string
      required: [name, surname, gov_id, email, phone, birthdate, password]
    UserUpdateRequest:
      type: object
      properties:
        name:
          type: string
        surname:
          type: string
        gov_id:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        birthdate:
          type: string
          format: date
        password:
          type: string
          format: password
          description: Required by current implementation (hashed before update).
      required: [password]
    UserWriteResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
          example: '123456789012'
      required: [success, user_id]
    UserDeleteResponse:
      allOf:
        - $ref: '#/components/schemas/UserWriteResponse'
    UserGroupMembership:
      type: object
      properties:
        user:
          type: string
        group:
          type: string
        expiration:
          type: string
          format: date
      required: [user, group]
    UserGroupAssignmentRequest:
      type: object
      properties:
        groupId:
          type: string
          description: Target group identifier.
        manualExpiration:
          type: string
          format: date
          description: Optional custom expiration date (YYYY-MM-DD).
      required: [groupId]
    UserGroupAssignmentResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        group_id:
          type: string
        expiration:
          type: string
          format: date
      required: [success, user_id, group_id]
    UserGroupRemovalResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        group_id:
          type: string
      required: [success, user_id, group_id]
    UserGroupsResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        groups:
          type: array
          items:
            $ref: '#/components/schemas/UserGroupMembership'
      required: [success, user_id, groups]
    UserAvailableGroupsResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        groups:
          type: array
          items:
            $ref: '#/components/schemas/Group'
      required: [success, user_id, groups]
    SuportInfo:
      oneOf:
        - type: object
          additionalProperties: true
        - type: string
    Suport:
      type: object
      properties:
        uid:
          type: string
        user:
          type: string
        activation:
          type: string
          format: date-time
        info:
          $ref: '#/components/schemas/SuportInfo'
      required: [uid]
    SuportListResponse:
      type: object
      properties:
        success:
          type: boolean
        user_id:
          type: string
        suports:
          type: array
          items:
            $ref: '#/components/schemas/Suport'
      required: [success, user_id, suports]
    SuportCreateRequest:
      type: object
      properties:
        uid:
          type: string
          description: Unique suport identifier to attach.
        info:
          $ref: '#/components/schemas/SuportInfo'
      required: [uid]
    SuportResponse:
      type: object
      properties:
        success:
          type: boolean
        suport:
          $ref: '#/components/schemas/Suport'
      required: [success, suport]
    SuportRemovalResponse:
      type: object
      properties:
        success:
          type: boolean
        uid:
          type: string
      required: [success, uid]
    Group:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        expiration:
          type: integer
          description: Days until expiration; null means never expires.
      required: [id, name, description]
    GroupListResponse:
      type: object
      properties:
        success:
          type: boolean
        groups:
          type: array
          items:
            $ref: '#/components/schemas/Group'
      required: [success, groups]
    GroupResponse:
      type: object
      properties:
        success:
          type: boolean
        group:
          $ref: '#/components/schemas/Group'
      required: [success, group]
    GroupWriteRequest:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        expiration:
          type: integer
      required: [name, description]
    GroupUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/GroupWriteRequest'
    Station:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        name_short:
          type: string
        available:
          type: boolean
        zones:
          type: array
          items:
            type: integer
      required: [id, name, name_short, available, zones]
    StationListResponse:
      type: object
      properties:
        success:
          type: boolean
        stations:
          type: array
          items:
            $ref: '#/components/schemas/Station'
      required: [success, stations]
    StationResponse:
      type: object
      properties:
        success:
          type: boolean
        station:
          $ref: '#/components/schemas/Station'
      required: [success, station]
    StationWriteRequest:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        name_short:
          type: string
        available:
          type: boolean
        zones:
          type: array
          items:
            type: integer
      required: [id, name, name_short, available]
    StationUpdateRequest:
      type: object
      properties:
        name:
          type: string
        name_short:
          type: string
        available:
          type: boolean
        zones:
          type: array
          items:
            type: integer
    StationDeleteResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: integer
          description: ID of the deleted station.
      required: [success, message]
    Zone:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
      required: [id, name, description]
    ZoneListResponse:
      type: object
      properties:
        success:
          type: boolean
        zones:
          type: array
          items:
            $ref: '#/components/schemas/Zone'
      required: [success, zones]
    ZoneResponse:
      type: object
      properties:
        success:
          type: boolean
        zone:
          $ref: '#/components/schemas/Zone'
      required: [success, zone]
    ZoneWriteRequest:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
      required: [id, name, description]
    ZoneUpdateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
    Title:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        uses:
          type: integer
        expiration:
          type: integer
          description: Days until expiration after activation.
        available:
          type: string
          format: date-time
        unavailable:
          type: string
          format: date-time
        price:
          type: number
          format: float
        num_zones:
          type: integer
        link:
          type: integer
          description: Minutes the validation stays linked for free interchanges.
        re_entry:
          type: integer
          description: Minutes before the same station can be validated again.
        groups:
          type: array
          description: Whitelist of allowed groups.
          items:
            type: integer
        excluded_groups:
          type: array
          description: Groups that cannot purchase this title.
          items:
            type: integer
      required:
        [id, name, description, available, unavailable, price, num_zones]
    TitleListResponse:
      type: object
      properties:
        success:
          type: boolean
        titles:
          type: array
          items:
            $ref: '#/components/schemas/Title'
      required: [success, titles]
    TitleResponse:
      type: object
      properties:
        success:
          type: boolean
        title:
          $ref: '#/components/schemas/Title'
      required: [success, title]
    TitleCreateRequest:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        uses:
          type: integer
        expiration:
          type: integer
        available:
          type: string
          format: date-time
        unavailable:
          type: string
          format: date-time
        price:
          type: number
          format: float
        num_zones:
          type: integer
        link:
          type: integer
        re_entry:
          type: integer
        groups:
          type: array
          description: Optional whitelist of groups that may buy the title (mutually exclusive with `excluded_groups`).
          items:
            type: integer
        excluded_groups:
          type: array
          description: Optional blacklist of groups (mutually exclusive with `groups`).
          items:
            type: integer
      required: [id, name, description, available, unavailable, price, num_zones]
    TitleUpdateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        uses:
          type: integer
        expiration:
          type: integer
        available:
          type: string
          format: date-time
        unavailable:
          type: string
          format: date-time
        price:
          type: number
          format: float
        num_zones:
          type: integer
        link:
          type: integer
        re_entry:
          type: integer
        groups:
          type: array
          items:
            type: integer
        excluded_groups:
          type: array
          items:
            type: integer
    UserTitle:
      type: object
      properties:
        id:
          type: string
        user:
          type: string
        title:
          type: integer
        title_name:
          type: string
          description: Title name from catalog (present on list/active endpoints).
        title_description:
          type: string
          description: Title description from catalog (present on list/active endpoints).
        uses_left:
          type: integer
        first_use:
          type: string
          format: date-time
        expiration:
          type: string
          format: date-time
        re_entry:
          type: integer
        zone_origin:
          type: integer
        active:
          type: boolean
        link:
          type: integer
        num_zones:
          type: integer
      required: [id, user, title, active]
    UserTitleListResponse:
      type: object
      properties:
        success:
          type: boolean
        titles:
          type: array
          items:
            $ref: '#/components/schemas/UserTitle'
      required: [success, titles]
    UserTitleResponse:
      type: object
      properties:
        success:
          type: boolean
        title:
          $ref: '#/components/schemas/UserTitle'
      required: [success, title]
    AssignTitleRequest:
      type: object
      properties:
        title:
          type: integer
          description: ID of the catalog title to assign.
      required: [title]
    AssignTitleResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: object
          description: Snapshot of the inserted `user_titles` record.
          properties:
            id:
              type: string
            user:
              type: string
            title:
              type: integer
            uses_left:
              type: integer
            expiration:
              type: string
              format: date
            re_entry:
              type: integer
            active:
              type: boolean
            link:
              type: integer
            num_zones:
              type: integer
      required: [success, message]
    UserTitleRemovalResponse:
      type: object
      properties:
        success:
          type: boolean
        title:
          $ref: '#/components/schemas/UserTitle'
      required: [success, title]
    ValidationRequest:
      type: object
      properties:
        suport:
          type: string
          description: Suport UID attempting to validate.
        station:
          type: integer
          description: Station identifier performing the validation.
      required: [suport, station]
    LocalizedMessage:
      type: object
      properties:
        ca:
          type: string
        en:
          type: string
        es:
          type: string
      required: [ca, en, es]
    ValidationMessage:
      type: object
      properties:
        success:
          type: boolean
        code:
          type: integer
        status:
          type: string
          example: VALIDATION_SUCCESS
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        validation_id:
          type: integer
          description: Present when the validation record is inserted.
        timestamp:
          type: string
          format: date-time
        station_id:
          type: integer
        user_title_id:
          type: string
        uses_left:
          type: integer
        expiration:
          type: string
          format: date-time
        link:
          type: boolean
          description: Indicates whether the validation was free because it was within link time.
      required: [success, code, status, msg]
    ValidationSuccessMessage:
      type: object
      properties:
        success:
          const: true
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        validation_id:
          type: integer
        timestamp:
          type: string
          format: date-time
        station_id:
          type: integer
        user_title_id:
          type: string
        uses_left:
          type: integer
        expiration:
          type: string
          format: date-time
        link:
          type: boolean
      required:
        [success, code, status, msg, validation_id, timestamp, station_id, user_title_id, uses_left, expiration, link]
      additionalProperties: false
    ValidationErrorMessage:
      type: object
      properties:
        success:
          const: false
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        internal:
          type: string
          description: Optional internal error detail for server errors.
      required: [success, code, status, msg]
      additionalProperties: false
    ValidationSuccess:
      allOf:
        - $ref: '#/components/schemas/ValidationSuccessMessage'
        - type: object
          properties:
            code:
              const: 200
            status:
              const: VALIDATION_SUCCESS
    ValidationMissingParameters:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 400
            status:
              const: ERROR_MISSING_PARAMETERS
    ValidationSuportNotFound:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 404
            status:
              const: ERROR_SUPORT_NOT_FOUND
    ValidationStationNotAvailable:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 404
            status:
              const: ERROR_STATION_NOT_AVAILABLE
    ValidationNoActiveTitle:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 404
            status:
              const: ERROR_NO_USER_TITLE_ACTIVE
    ValidationSuportInactive:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 403
            status:
              const: ERROR_SUPORT_INACTIVE
    ValidationCannotInitialize:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 403
            status:
              const: ERROR_CANNOT_INITIALIZE_USER_TITLE
    ValidationInvalidZone:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 403
            status:
              const: ERROR_USER_TITLE_NOT_VALID_FOR_ZONE
    ValidationTitleExpired:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 410
            status:
              const: ERROR_USER_TITLE_EXPIRED
    ValidationNoUsesLeft:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 410
            status:
              const: ERROR_NO_USES_LEFT
    ValidationReentryNotPassed:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 429
            status:
              const: ERROR_REENTRY_TIME_NOT_PASSED
    ValidationInternalServer:
      allOf:
        - $ref: '#/components/schemas/ValidationErrorMessage'
        - type: object
          properties:
            code:
              const: 500
            status:
              const: ERROR_INTERNAL_SERVER
    ValidationHistoryItem:
      type: object
      properties:
        id:
          type: integer
          description: Sequential identifier assigned by the API (newest first).
        timestamp:
          type: string
          format: date-time
        station:
          type: string
        suport:
          type: string
        title:
          type: string
      required: [id, timestamp, station, suport, title]
    ValidationHistoryMessage:
      type: object
      properties:
        success:
          type: boolean
        code:
          type: integer
        status:
          type: string
          example: HISTORY_FETCH_SUCCESS
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        user_id:
          type: string
        validations:
          type: array
          items:
            $ref: '#/components/schemas/ValidationHistoryItem'
      required: [success, code, status, msg]
    ValidationHistorySuccessMessage:
      type: object
      properties:
        success:
          const: true
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        user_id:
          type: string
        validations:
          type: array
          items:
            $ref: '#/components/schemas/ValidationHistoryItem'
      required: [success, code, status, msg, user_id, validations]
      additionalProperties: false
    ValidationHistoryErrorMessage:
      type: object
      properties:
        success:
          const: false
        code:
          type: integer
        status:
          type: string
        msg:
          $ref: '#/components/schemas/LocalizedMessage'
        internal:
          type: string
          description: Optional internal error detail for server errors.
      required: [success, code, status, msg]
      additionalProperties: false
    ValidationHistorySuccess:
      allOf:
        - $ref: '#/components/schemas/ValidationHistorySuccessMessage'
        - type: object
          properties:
            code:
              const: 200
            status:
              const: HISTORY_FETCH_SUCCESS
    ValidationHistoryInternalServer:
      allOf:
        - $ref: '#/components/schemas/ValidationHistoryErrorMessage'
        - type: object
          properties:
            code:
              const: 500
            status:
              const: ERROR_INTERNAL_SERVER
